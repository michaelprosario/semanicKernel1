
@using Markdig
@using Microsoft.SemanticKernel;
@using Microsoft.SemanticKernel.ChatCompletion;
@using Microsoft.SemanticKernel.Connectors.OpenAI;
@using ModelContextProtocol;
@using ModelContextProtocol.Client;
@using ModelContextProtocol.Protocol.Transport;
@using Microsoft.SemanticKernel.Agents;
@inject IJSRuntime JS;
@inject IConfiguration Configuration;

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">AI Chat Assistant</h3>
                </div>
                <div class="card-body">
                    <div class="chat-container mb-3" style="height: 400px; overflow-y: auto;" @ref="chatContainerRef">
                        @foreach (var message in chatHistory)
                        {
                            <div class="@(message.Role == AuthorRole.User ? "user-message" : "assistant-message") mb-2 p-2 rounded">
                                <strong>@(message.Role == AuthorRole.User ? "User" : "Assistant")</strong>
                                <div>@this.GetHtmlFromMarkDown(@message.Content)</div>
                            </div>
                        }
                        @if (isLoading)
                        {
                            <div class="assistant-message mb-2 p-2 rounded">
                                <strong>Assistant</strong>
                                <div class="typing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Type your message..."
                        @bind="userInput"
                        @bind:event="oninput"
                        @onkeydown="@HandleKeyPress" />
                        <button class="btn btn-primary" @onclick="SendMessage" disabled="@(string.IsNullOrWhiteSpace(userInput) || isLoading)">
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-outline-secondary" @onclick="ClearChat">Clear Chat</button>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    #pragma warning disable SKEXP0001 // Type is for evaluation purposes only and is subject to change or removal in future updates. Suppress this diagnostic to proceed.

    private ChatHistory chatHistory = new();
    private string userInput = string.Empty;
    private bool isLoading = false;
    private ElementReference chatContainerRef;
    Kernel kernel;
    IChatCompletionService ChatCompletionService;
    ChatCompletionAgent agent;

    OpenAIPromptExecutionSettings executionSettings;

    public MarkupString GetHtmlFromMarkDown(string input){
        if(string.IsNullOrWhiteSpace(input))
            return new MarkupString("System returned empty response. :(");

        return new MarkupString(Markdown.ToHtml(input));
    }

    protected override async Task OnInitializedAsync()
    {
        string openAiApiKey = Configuration["OPENAI_API_KEY"];
        string modelId = "gpt-4o-mini";

        // Create a kernel with Azure OpenAI chat completion
        var builder = Kernel.CreateBuilder();
        builder.Services.AddOpenAIChatCompletion(modelId, openAiApiKey);

        // Create an MCPClient for the GitHub server
        await using IMcpClient mcpClient = await McpClientFactory.CreateAsync(new StdioClientTransport(new()
            {
                Name = "mcp1",
                Command = "dotnet",
                Arguments = [
                    "run", 
                    "--project",
                    "C:\\dev\\AiPlayground1\\PodcastsMcp\\PodcastsMcp.csproj"
                    ],
            }));

        var tools = await mcpClient.ListToolsAsync().ConfigureAwait(false);
        foreach (var tool in tools)
        {
            Console.WriteLine($"{tool.Name}: {tool.Description}");
        }            


        kernel = builder.Build();
        kernel.Plugins.AddFromFunctions("mcp1", tools.Select(aiFunction => aiFunction.AsKernelFunction()));

        // Enable automatic function calling
        executionSettings = new()
        {
            Temperature = 0,
            FunctionChoiceBehavior = FunctionChoiceBehavior.Auto(options: new() { RetainArgumentTypes = true })
        };        

        agent =
            new ChatCompletionAgent
            {
                Instructions = "Answer questions and use tools when needed.",
                Name = "myAgent",
                Kernel = kernel,
                Arguments = new KernelArguments(executionSettings),
            };            
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await ScrollToBottom();
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JS.InvokeVoidAsync("scrollToBottom", chatContainerRef);
        }
        catch
        {
            // Handle any exceptions that might occur
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(userInput) && !isLoading)
        {
            await SendMessage();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(userInput) || isLoading)
            return;

        string message = userInput.Trim();
        userInput = string.Empty;

        // Add user message to history
        chatHistory.AddUserMessage(message);
        StateHasChanged();
        await ScrollToBottom();

        isLoading = true;
        StateHasChanged();

        try
        {

            // Get response from AI
            var result = await agent.InvokeAsync(message).FirstAsync();

            // Add AI response to history
            chatHistory.AddMessage(AuthorRole.Assistant, result.Message.Content ?? string.Empty);
        }
        catch (Exception ex)
        {
            // Handle exception
            chatHistory.AddAssistantMessage($"I encountered an error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
            await ScrollToBottom();
        }
    }

    private void ClearChat()
    {
        chatHistory = new ChatHistory();
        StateHasChanged();
    }
}